# install minikube, kubectl, helm

minikube start -p production
minikube start -p monitor

kubectl config use-context monitor

# ECK
# sudo snap install helm --classic
helm repo add elastic https://helm.elastic.co
helm repo update
helm install elastic-operator elastic/eck-operator -n elastic-system --create-namespace

# crossplane
kubectl create namespace crossplane-system

helm repo add crossplane-stable https://charts.crossplane.io/stable
helm repo update

helm install crossplane --namespace crossplane-system crossplane-stable/crossplane

# Deploy EK
kubectl apply -f EK/elastic.yaml 
kubectl apply -f EK/kibana.yaml 

# Filebeat
kubectl apply -f EK/filebeat.yaml

# Login to kibana, get url with
minikube service -p monitor --url --https=true kibana-kb-http

# User elactic, get password with:
kubectl get secret elasticsearch-es-elastic-user -o=jsonpath='{.data.elastic}' | base64 --decode; echo

# Production
export IP_ADDR=$(hostname -I|cut -d ' ' -f 1) 
export ELASTIC_CONN=$(kubectl get secret elasticsearch-es-elastic-user -o=jsonpath='{.data.elastic}' | base64 --decode; echo)
kubectl port-forward services/elasticsearch-es-internal-http 9200 --address="${IP_ADDR}" &

kubectl config use-context production
# ECK
helm install elastic-operator elastic/eck-operator -n elastic-system --create-namespace

# Filebeat
envsubst < EK/filebeat_prod.yaml '$IP_ADDR,$ELASTIC_CONN'|kubectl apply -f -
